@model IEnumerable<LetdsGoAndDive.Models.Message>

@{
    var user = ViewBag.User as string;
    ViewData["Title"] = "Chat with Admin";
}

<h2>Chat with Admin</h2>

<div id="messagesList" style="height:400px; overflow-y:auto; border:1px solid #ccc; padding:10px;">
    @foreach (var msg in Model)
    {
        <div style="@(msg.Sender == user ? "text-align:right;" : "text-align:left;")">
            <strong>@msg.Sender:</strong> @msg.Text <br />
            <small class="text-muted">@msg.SentAt.ToString("hh:mm tt")</small>
        </div>
    }
</div>

<div class="input-group mt-3">
    <input type="text" id="messageInput" placeholder="Type your message..." class="form-control" />
    <button id="sendButton" class="btn btn-primary">Send</button>
</div>

<script src="~/lib/microsoft-signalr/signalr.min.js"></script>
<script>
    (() => {
        const currentUser = "@user".trim();

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chathub") // ✅ fixed: relative path only
            .withAutomaticReconnect()
            .configureLogging(signalR.LogLevel.Information)
            .build();

        connection.on("ReceiveMessage", (sender, message) => {
            const msg = document.createElement("div");
            msg.style.textAlign = sender === currentUser ? "right" : "left";
            msg.innerHTML = `<strong>${sender}:</strong> ${message}<br/><small>${new Date().toLocaleTimeString()}</small>`;
            const list = document.getElementById("messagesList");
            list.appendChild(msg);
            list.scrollTop = list.scrollHeight;
        });

        connection.on("ConversationDeleted", (target) => {
            if (target === currentUser) {
                alert("Your conversation was deleted by admin.");
                location.reload();
            }
        });

        async function start() {
            try {
                await connection.start();
                console.log("✅ Connected as user:", currentUser);
            } catch (err) {
                console.error("Connection failed:", err);
                setTimeout(start, 2000);
            }
        }

        document.addEventListener("DOMContentLoaded", start);

        document.getElementById("sendButton").addEventListener("click", async () => {
            const message = document.getElementById("messageInput").value.trim();
            if (!message) return;
            try {
                await connection.invoke("SendMessage", currentUser, message, "AdminGroup");
                document.getElementById("messageInput").value = "";
            } catch (err) {
                console.error("Send failed:", err);
            }
        });

        document.getElementById("messageInput").addEventListener("keypress", e => {
            if (e.key === "Enter") {
                e.preventDefault();
                document.getElementById("sendButton").click();
            }
        });
    })();
</script>
