@model Shoppingcart
@{
    ViewData["Title"] = "GetUserCart";
}

<link rel="stylesheet" href="~/css/cart-style.css" />

<div style="width: 90%; margin:auto" class="mt-2 cart-container">
    @if (Model != null && Model.CartDetails != null && Model.CartDetails.Count > 0)
    {
        <h3>My Cart</h3>

        <form id="cartForm" method="post" asp-controller="Cart" asp-action="ProceedSelectedCheckout">
            <table class="table table-striped cart-table">
                <tr>
                    <th class="checkbox-col"><input type="checkbox" id="selectAll" /></th>
                    <th>Product</th>
                    <th>Image</th>
                    <th>Item Type</th>
                    <th>Unit Price</th>
                    <th>Qty</th>
                    <th class="total-col">Total Price</th>
                    <th>Action</th>
                </tr>

                @foreach (var item in Model.CartDetails)
                {
                    <tr data-product-id="@item.ProductId">
                        <td class="checkbox-col">
                            <input type="checkbox" name="selectedItems" value="@item.ProductId" class="item-checkbox" data-price="@((item.Product?.Price ?? 0) * item.Quanntity)" />
                        </td>
                        <td>@(item.Product?.ProductName ?? "N/A")</td>
                        <td>
                            <img src="~/images/@(string.IsNullOrEmpty(item.Product?.Image) ? "No_Image_Available.jpg" : item.Product.Image)"
                         asp-append-version="true"
                         style="width:80px;height:100px;object-fit:cover;" />
                        </td>
                        <td>@(item.Product?.ItemType?.ItemTypeName ?? "N/A")</td>
                        <td class="unit-price">@((item.Product?.Price ?? 0).ToString("N2"))</td>
                        <td class="quantity">@item.Quanntity</td>
                        <td class="total-col">₱@(((item.Product?.Price ?? 0) * item.Quanntity).ToString("N2"))</td>



                        <td>
                            <button type="button" class="btn btn-info btnAdd" data-productid="@item.ProductId">+</button>
                            <button type="button" class="btn btn-info btnRemove" data-productid="@item.ProductId">-</button>

                        </td>
                    </tr>
                }
            </table>

            <div class="cart-total">
                <span>Total (₱): </span>
                <span id="selectedTotal">0</span>
            </div>

            <div class="my-2 text-end">
                <button type="submit" id="checkoutButton" class="btn btn-primary" disabled>Checkout Selected</button>
            </div>
        </form>
    }
    else
    {
        <h5 class="cart-empty">Cart is Empty</h5>
    }
</div>

@section Scripts {
    <script>
       
        const checkboxes = document.querySelectorAll('.item-checkbox');
        const selectAll = document.getElementById('selectAll');
        const totalDisplay = document.getElementById('selectedTotal');
        const checkoutButton = document.getElementById('checkoutButton');

        function updateTotal() {
            let total = 0;
            const checked = document.querySelectorAll('.item-checkbox:checked');
            checked.forEach(cb => total += parseFloat(cb.dataset.price));
            totalDisplay.textContent = total.toFixed(2);
            checkoutButton.disabled = checked.length === 0;
        }

        checkboxes.forEach(cb => cb.addEventListener('change', updateTotal));
        selectAll?.addEventListener('change', () => {
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateTotal();
        });
        updateTotal();

        document.querySelectorAll('.btnAdd').forEach(btn => {
            btn.addEventListener('click', async function () {
                const productId = this.dataset.productid;
                const resp = await fetch(`/Cart/AddItem?productId=${productId}`, { credentials: 'include' });
                const data = await resp.json();
                if (data.success) {
                    location.reload(); // refresh cart table
                } else {
                    alert(data.message || 'Error adding item');
                }
            });
        });

        document.querySelectorAll('.btnRemove').forEach(btn => {
            btn.addEventListener('click', async function () {
                const productId = this.dataset.productid;
                const resp = await fetch(`/Cart/RemoveItem?productId=${productId}`, { credentials: 'include' });
                const data = await resp.json();
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || 'Error removing item');
                }
            });
        });
    </script>
}
