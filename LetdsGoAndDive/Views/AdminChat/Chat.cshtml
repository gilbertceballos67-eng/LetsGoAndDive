@model IEnumerable<LetdsGoAndDive.Models.Message>

@{
    var user = ViewBag.User as string;
    ViewData["Title"] = "Chat with " + user;
}

<h2>Chat with @user</h2>

<div id="messagesList" style="height:400px; overflow-y:auto; border:1px solid #ccc; padding:10px;">
    @foreach (var msg in Model)
    {
        <div style="@(msg.Sender == "AdminGroup" ? "text-align:right;" : "text-align:left;")">
            <strong>@msg.Sender:</strong> @msg.Text <br />
            <small class="text-muted">@msg.SentAt.ToString("hh:mm tt")</small>
        </div>
    }
</div>

<div class="input-group mt-3">
    <input type="text" id="messageInput" placeholder="Type your reply..." class="form-control" />
    <button id="sendButton" class="btn btn-success">Send</button>
</div>



<script src="~/lib/microsoft-signalr/signalr.min.js"></script>
<script>
    (() => {
        const targetUser = "@user".trim();
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chathub")
            .withAutomaticReconnect()
            .configureLogging(signalR.LogLevel.Information)
            .build();
        connection.on("UpdateUnreadCount", () => { /* Do nothing */ });
        connection.on("receivemessage", (sender, message) => {
            console.log("Received message from", sender, ":", message);  // ✅ ADD: Debug log
            const msg = document.createElement("div");
            msg.style.textAlign = sender === "AdminGroup" ? "right" : "left";
            msg.innerHTML = `<strong>${sender}:</strong> ${message}<br/><small>${new Date().toLocaleTimeString()}</small>`;
            const list = document.getElementById("messagesList");
            list.appendChild(msg);
            list.scrollTop = list.scrollHeight;
        });
        connection.on("conversationdeleted", function (target) {  
            if (target === targetUser) {
                alert("Conversation deleted.");
                document.getElementById("messagesList").innerHTML = "";
            }
        });
        async function startConnection() {
            try {
                await connection.start();
                console.log("Connected");
                
                await connection.invoke("JoinGroup", "AdminGroup");
            } catch (err) {
                console.error("Connection failed:", err);
                await connection.stop();
                setTimeout(startConnection, 5000);
            }
        }

        
        document.addEventListener("DOMContentLoaded", startConnection);  

        document.getElementById("sendButton").addEventListener("click", async () => {
            const message = document.getElementById("messageInput").value.trim();
            if (!message) return;
            try {
                await connection.invoke("SendMessage", "AdminGroup", message, targetUser);
                document.getElementById("messageInput").value = "";
            } catch (err) {
                console.error("Send failed:", err);
            }
        });

        
        document.getElementById("messageInput").addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                document.getElementById("sendButton").click();
            }
        });
    })();
</script>